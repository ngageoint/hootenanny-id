<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>Hootenanny</title>
    <base href="/">
    <link rel="icon" href="favicon.ico"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel='stylesheet' href='./iD.css'>

    <!-- mobile devices -->
    <meta name='viewport' content='initial-scale=1.0 maximum-scale=1.0'>
    <meta name='apple-mobile-web-app-capable' content='yes' />
    <meta name='apple-mobile-web-app-status-bar-style' content='black-translucent' />
</head>
<body>
<div id='id-container'>
    <div id="id-sink"></div>
</div>
<!--[if !IE]>-->
<script src='./iD.min.js'></script>
<!--<![endif]-->
<script>
    // google analytics
    //var _gaq = _gaq || [];
    //_gaq.push(['_setAccount', 'UA-38039653-2']);
    //_gaq.push(['_trackPageview']);
    //(function() {
    //    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    //    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    //    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    //})();

    // crazyegg
    //setTimeout(function(){var a=document.createElement('script');
    //    var b=document.getElementsByTagName('script')[0];
    //    a.src=document.location.protocol+'//dnn506yrbagrg.cloudfront.net/pages/scripts/0013/6714.js?'+Math.floor(new Date().getTime()/3600000);
    //    a.async=true;a.type='text/javascript';b.parentNode.insertBefore(a,b)}, 1);

    if (typeof iD == 'undefined' || !iD.Detect().support) {
        document.getElementById('id-container').innerHTML = 'Sorry, your browser is not currently supported. Please use Potlatch 2 to edit the map.';
        document.getElementById('id-container').className = 'unsupported';

    } else {
        // var id = iD.Context();
        //
        // // disable boundaries (unless we have an explicit disable_features list)
        // var q = iD.utilStringQs(window.location.hash.substring(1));
        // if (!q.hasOwnProperty('disable_features')) {
        //     id.features().disable('boundaries');
        // }
        //
        // id.ui()(document.getElementById('id-sink'), function() {
        //     id.container().select('#about-list')
        //         .insert('li', '.user-list')
        //         .attr('class', 'source-switch')
        //         .call(iD.uiSourceSwitch(id)
        //             .keys([{
        //                 'urlroot': 'https://www.openstreetmap.org',
        //                 'oauth_consumer_key': '5A043yRSEugj4DJ5TljuapfnrflWDte8jTOcWLlT',
        //                 'oauth_secret': 'aB3jKq1TRsCOUrfOIZ6oQMEDmv2ptV76PA54NGLL'
        //             }, {
        //                 'urlroot': 'https://api06.dev.openstreetmap.org',
        //                 'oauth_consumer_key': 'zwQZFivccHkLs3a8Rq5CoS412fE5aPCXDw9DZj7R',
        //                 'oauth_secret': 'aMnOOCwExO2XYtRVWJ1bI9QOdqh1cay2UgpbhA6p'
        //             }
        //             ])
        //         );
        // });
        let id = iD.Context(),
            hoot = id.hoot;
        function findGetParameter(parameterName) {
            var result = null,
                tmp = [];
            location.search
                .substr(1)
                .split("&")
                .forEach(function (item) {
                    tmp = item.split("=");
                    if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
                });
            return result;
        }

        var oauth_token = findGetParameter('oauth_token');
        var oauth_verifier = findGetParameter('oauth_verifier');

        if(oauth_token && oauth_verifier) {
            // if we have these tokens, this is the spawned popup-
            d3.json('/hoot-services/auth/oauth1/verify?oauth_verifier=' + oauth_verifier + '&oauth_token=' + oauth_token, function( e, r ) {
                if(e) {
                    console.log( e );
                    console.warn('failed to verify oauth tokens w/ provider:');
                    console.warn('XMLHttpRequest.status', e.status || null);
                    console.warn('XMLHttpRequest.responseText ', e.responseText || null);

                    if(opener) {
                        window.onbeforeunload = function() {
                            opener.oAuthDone(e, null);
                        };

                        window.close();
                    } else {
                        window.alert('Failed to complete oauth handshake. Check console for details & retry.');
                        // clear oauth params.
                        window.history.pushState({}, document.title, window.location.pathname);
                    }

                } else {
                    if(opener) {
                        console.log( r );
                        window.alert( 'wait' );
                        window.onbeforeunload = function() {
                            opener.oAuthDone(null, r);
                        };

                        window.close();
                    } else {
                        // force refresh.
                        window.location.reload(true);
                    }
                }
            })
        } else {
            function load() {
                console.log( 'load' );
                // // unload landing page.
                // Hoot.view.unload_login();
                //
                // // load application.
                // id.hoot().load(function() {
                //     d3.select('#id-container').call(id.ui());
                // });
            }

            // launch popup & attach callback function
            // to child window.
            function launchLogin(oauth_redirect_url) {
                console.log( 'launch' );
                window.open(oauth_redirect_url, "hootenanny_login_redirect", "width=500,height=800,toolbar=no,status=no,menubar=no");

                window.oAuthDone = function(e, user_object) {
                    if(e) {
                        console.warn('failed to verify oauth tokens w/ provider:');
                        console.warn('XMLHttpRequest.status', e.status || null);
                        console.warn('XMLHttpRequest.responseText ', e.responseText || null);

                        window.alert('Failed to complete oauth handshake. Check console for details & retry.');
                        window.history.pushState({}, document.title, window.location.pathname);

                    } else {
                        if(localStorage) {
                            localStorage.setItem('user', JSON.stringify(user_object));
                        }

                        load();
                    }
                }
            }

            // hoot.checkLogin()
            //     .then( () => load() )
            //     .catch( () => hoot.renderLogin( load ) );

            hoot.api.getServicesVersionInfo()
                .then( () => load() )
                .catch( () => {
                    hoot.api.getOAuthRedirectUrl()
                        .then( oauthRedirectUrl => {
                            hoot.login.render( () => launchLogin( oauthRedirectUrl ) )
                        } )
                        .catch( err => {
                            console.log( 'get oauth redirect error' );
                            console.log( err );
                        } );
                } );
        }
    }
</script>
</body>
</html>
